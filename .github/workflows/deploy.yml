name: CI/CD Pipeline Locale

on:
  push:
    branches:
      - main

jobs:
  build-push-deploy:
    runs-on: self-hosted  # Usa il runner locale ARC

    env:
      HARBOR_URL: harbor.local
      IMAGE_NAME: myproject/myapp   # Personalizza con il nome che preferisci
      HARBOR_USER: admin
      HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}

    steps:
      - name: Checkout del codice
        uses: actions/checkout@v4

      - name: Login su Harbor locale
        run: |
          echo "$HARBOR_PASSWORD" | docker login $HARBOR_URL -u $HARBOR_USER --password-stdin

      - name: Build immagine Docker
        run: |
          docker build -t ${HARBOR_URL}/${IMAGE_NAME}:${{ github.sha }} .

      - name: Push immagine su Harbor
        run: |
          docker push ${HARBOR_URL}/${IMAGE_NAME}:${{ github.sha }}

      - name: Setup kubectl e Helm
        run: |
          sudo snap install kubectl --classic --force
          sudo snap install helm --classic --force
          mkdir -p ~/.kube
          microk8s config > ~/.kube/config

      - name: Deploy con Helm su MicroK8s
        run: |
          helm upgrade --install myapp ./chart \
            --set image.repository=${HARBOR_URL}/${IMAGE_NAME} \
            --set image.tag=${{ github.sha }}
